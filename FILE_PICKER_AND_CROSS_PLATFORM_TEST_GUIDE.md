# 文件选择器与跨平台功能 - 测试指南

**完成时间**: 2026-01-24
**功能**: 文件/文件夹选择器 + 跨平台路径处理
**状态**: ✅ 实现完成，待测试验证

---

## 📋 功能概述

### 新增功能

1. **文件选择器 Hook (`useFilePicker`)**
   - 支持文件/文件夹选择
   - 多环境支持（Web、Tauri、Electron）
   - 自动降级到手动输入

2. **跨平台路径工具 (`pathUtils`)**
   - 路径规范化（Windows ↔ Unix）
   - 平台检测
   - 路径验证
   - 路径显示格式化

3. **更新的组件**
   - `RepoPathManagement.tsx` - 仓库路径管理
   - `ConfigSourceManagement.tsx` - 配置源管理
   - `FirstRunWizard.tsx` - 首次运行向导

---

## 🧪 测试步骤

### 前置准备

#### 1. 启动应用

```bash
# Windows
start-dev.bat

# 或手动启动
cd frontend
npm run dev
```

#### 2. 访问应用

打开浏览器访问 `http://localhost:3000`

---

## 📝 测试检查清单

### 测试1：文件选择器功能（P0 - 最高优先级）

#### 1.1 仓库路径修复测试

**位置**: Settings > Data Management > Repos

**测试步骤**:
1. 进入 Settings > Data Management 页面
2. 切换到 "仓库" 标签页
3. 点击 "扫描仓库" 按钮
4. 等待扫描完成，查看是否有无效仓库
5. 如果有无效仓库，点击 "修复路径" 按钮
6. 观察文件选择器的行为

**预期结果**:
- [ ] 点击 "修复路径" 后触发文件选择器
- [ ] 文件选择器显示标题 "选择仓库 {仓库名} 的新路径"
- [ ] 可以选择文件夹
- [ ] 选择后路径被自动规范化
- [ ] Toast 显示 "仓库路径已更新" 或相应的错误消息

**浏览器兼容性**:
- [ ] Chrome/Edge (支持 File System Access API)
- [ ] Firefox (降级到 prompt 输入)
- [ ] Safari (降级到 prompt 输入)

**截图位置**: 仓库路径管理页面

---

#### 1.2 配置源切换测试

**位置**: Settings > Data Management > Configuration

**测试步骤**:
1. 进入 Settings > Data Management 页面
2. 切换到 "配置" 标签页
3. 找到 "切换配置源" 卡片
4. 点击路径输入框旁边的文件夹图标按钮
5. 观察文件选择器的行为

**预期结果**:
- [ ] 点击文件夹图标后触发文件选择器
- [ ] 文件选择器显示标题 "选择配置目录"
- [ ] 可以选择文件夹
- [ ] 选择后路径被自动规范化并显示在输入框中
- [ ] Toast 显示相应的成功或错误消息

**截图位置**: 配置源管理页面

---

#### 1.3 首次运行向导测试

**位置**: 首次启动应用时

**测试步骤**:
1. 重置应用配置（删除或重命名 `custom_path.json`）
2. 重新启动应用
3. 在向导中选择 "使用现有配置" 选项
4. 点击路径输入框旁边的文件夹图标按钮
5. 观察文件选择器的行为

**预期结果**:
- [ ] 点击文件夹图标后触发文件选择器
- [ ] 文件选择器显示提示信息
- [ ] 可以选择文件夹
- [ ] 选择后路径被自动规范化
- [ ] 配置验证自动运行
- [ ] 显示验证结果（绿色勾选或红色叉号）

**截图位置**: 首次运行向导 - 选择配置页面

---

### 测试2：跨平台路径处理（P0 - 最高优先级）

#### 2.1 路径规范化测试

**测试数据**:

| 输入路径 | 预期输出 |
|---------|---------|
| `C:\Users\test\repo` | `C:\Users\test\repo` |
| `C:\\Users\\test\\repo` | `C:\Users\test\repo` |
| `C:/Users/test/repo` | `C:\Users\test\repo` |
| `/home/user/repo` | `/home/user/repo` |
| `home/user/repo` | `home/user/repo` |
| `/home/user/repo/` | `/home/user/repo` |

**测试步骤**:
1. 在各个路径输入场景中输入上述路径
2. 观察路径是否被正确规范化

**预期结果**:
- [ ] Windows 路径保持反斜杠格式
- [ ] Unix 路径保持正斜杠格式
- [ ] 连续的分隔符被合并
- [ ] 尾部分隔符被移除
- [ ] 混合格式的路径被正确转换

---

#### 2.2 平台检测测试

**测试步骤**:
1. 在不同操作系统上运行应用
2. 检查路径分隔符是否正确

**预期结果**:
- [ ] Windows: 使用反斜杠 `\`
- [ ] macOS: 使用正斜杠 `/`
- [ ] Linux: 使用正斜杠 `/`

**测试环境**:
- [ ] Windows 10/11
- [ ] macOS (Intel/Apple Silicon)
- [ ] Linux (Ubuntu/Debian)

---

#### 2.3 路径验证测试

**测试数据**:

| 输入路径 | 是否有效 | 原因 |
|---------|---------|------|
| `C:\valid\path` | ✅ 有效 | 正常路径 |
| `path\with\<:invalid` | ❌ 无效 | 包含非法字符 |
| `CON` | ❌ 无效 | Windows 保留名称 |
| `path/to/file` | ✅ 有效 | Unix 风格路径 |

**测试步骤**:
1. 尝试输入各种有效和无效的路径
2. 观察验证结果

**预期结果**:
- [ ] 有效路径被接受
- [ ] 无效路径被拒绝并显示错误消息
- [ ] Windows 保留名称被检测并拒绝

---

### 测试3：降级方案测试（P1 - 高优先级）

#### 3.1 不支持 File System Access API 的浏览器

**测试环境**: Firefox, Safari

**测试步骤**:
1. 在 Firefox 或 Safari 中打开应用
2. 尝试使用文件选择功能
3. 观察降级行为

**预期结果**:
- [ ] 降级到 prompt 输入
- [ ] 显示提示 "选择文件夹或输入文件夹路径"
- [ ] 手动输入的路径被正确处理
- [ ] 输入后路径被正确规范化

---

#### 3.2 Tauri/Electron 环境

**测试环境**: Tauri 或 Electron 打包的应用

**测试步骤**:
1. 在 Tauri/Electron 环境中运行应用
2. 尝试使用文件选择功能
3. 观察是否使用原生文件选择器

**预期结果**:
- [ ] 使用原生文件选择器（如果可用）
- [ ] 文件选择器显示原生 UI
- [ ] 选择后路径被正确处理

---

### 测试4：国际化测试（P1 - 高优先级）

#### 4.1 中文界面测试

**测试步骤**:
1. 切换语言到 "简体中文"
2. 测试所有文件选择功能
3. 检查提示消息

**预期结果**:
- [ ] 文件选择器标题显示中文
- [ ] Toast 消息显示中文
- [ ] 错误消息显示中文
- [ ] 按钮文本显示中文

---

#### 4.2 英文界面测试

**测试步骤**:
1. 切换语言到 "English"
2. 测试所有文件选择功能
3. 检查提示消息

**预期结果**:
- [ ] File picker title shows in English
- [ ] Toast messages show in English
- [ ] Error messages show in English
- [ ] Button text shows in English

---

### 测试5：错误处理测试（P1 - 高优先级）

#### 5.1 用户取消选择

**测试步骤**:
1. 点击文件选择按钮
2. 在文件选择器中点击 "取消"

**预期结果**:
- [ ] 路径输入框保持原值
- [ ] 没有错误提示
- [ ] 应用状态正常

---

#### 5.2 无效路径处理

**测试步骤**:
1. 手动输入一个无效的路径
2. 点击提交或应用按钮

**预期结果**:
- [ ] 显示错误消息
- [ ] 路径未被应用
- [ ] 提示用户重新选择

---

#### 5.3 权限错误处理

**测试步骤**:
1. 尝试选择一个无权访问的目录
2. 观察错误处理

**预期结果**:
- [ ] 显示权限错误消息
- [ ] 提示用户选择其他目录
- [ ] 应用状态正常

---

### 测试6：边界情况测试（P2 - 中等优先级）

#### 6.1 空路径测试

**测试步骤**:
1. 清空路径输入框
2. 尝试提交

**预期结果**:
- [ ] 显示验证错误
- [ ] 提示用户必须选择路径

---

#### 6.2 超长路径测试

**测试步骤**:
1. 输入一个超长路径（> 260 字符）
2. 观察处理方式

**预期结果**:
- [ ] 显示路径长度错误
- [ ] 或自动截断/处理

---

#### 6.3 特殊字符路径测试

**测试步骤**:
1. 输入包含特殊字符的路径
2. 观察处理方式

**测试数据**:
- 包含空格的路径: `C:\My Documents\repo`
- 包含 Unicode 的路径: `C:\用户\仓库`
- 包含点号的路径: `C:\.config\repo`

**预期结果**:
- [ ] 空格被正确处理
- [ ] Unicode 字符被正确处理
- [ ] 点号被正确处理

---

## 🎯 完整测试流程

### 手动测试步骤

1. **启动应用**
   ```bash
   cd frontend
   npm run dev
   ```

2. **测试仓库路径修复**
   - 访问 Settings > Data Management > Repos
   - 扫描仓库
   - 修复无效路径
   - 验证路径规范化

3. **测试配置源切换**
   - 访问 Settings > Data Management > Configuration
   - 点击文件夹图标
   - 选择新目录
   - 验证切换成功

4. **测试首次运行向导**
   - 重置配置
   - 重启应用
   - 跟随向导
   - 验证配置选择

5. **跨平台测试**
   - 在不同操作系统上重复上述步骤
   - 验证路径格式正确

6. **国际化测试**
   - 切换语言
   - 验证所有文本显示正确

---

## 🐛 已知问题

### 可能出现的问题

#### 问题1: File System Access API 不支持

**症状**: 文件选择器按钮点击后没有反应

**解决方案**:
1. 检查浏览器是否支持 File System Access API
2. 应自动降级到 prompt 输入
3. 如果未降级，检查控制台错误

**调试命令**:
```javascript
// 在浏览器控制台中运行
console.log('showDirectoryPicker' in window); // 应该返回 true 或 false
```

---

#### 问题2: 路径未规范化

**症状**: 路径包含连续的分隔符或错误的分隔符

**解决方案**:
1. 检查 `normalizePath` 函数是否被调用
2. 检查函数返回值
3. 查看是否有其他代码覆盖了规范化后的路径

**调试命令**:
```javascript
// 在浏览器控制台中运行
import { normalizePath } from './lib/pathUtils';
console.log(normalizePath('C:\\\\Users\\\\test\\\\repo'));
```

---

#### 问题3: 翻译键缺失

**症状**: 界面显示翻译键而不是文本

**解决方案**:
1. 检查翻译文件是否正确加载
2. 检查翻译键是否存在
3. 重启开发服务器

---

## 📊 测试报告模板

### 手动测试报告

```markdown
# 文件选择器与跨平台功能 - 测试报告

**测试人员**:
**测试日期**:
**应用版本**:
**测试环境**:
  - 操作系统:
  - 浏览器:
  - Node 版本:

---

## 测试结果

### ✅ 通过的测试

- [ ] 仓库路径修复 - 文件选择器正常工作
- [ ] 配置源切换 - 文件选择器正常工作
- [ ] 首次运行向导 - 文件选择器正常工作
- [ ] 路径规范化 - Windows 路径正确
- [ ] 路径规范化 - Unix 路径正确
- [ ] 平台检测 - 正确识别操作系统
- [ ] 路径验证 - 有效路径被接受
- [ ] 路径验证 - 无效路径被拒绝
- [ ] 降级方案 - Firefox/Safari 降级正常
- [ ] 国际化 - 中文界面正确
- [ ] 国际化 - 英文界面正确

### ❌ 失败的测试

- [ ] 测试项名称
  - **失败原因**:
  - **错误消息**:
  - **重现步骤**:

### ⚠️ 发现的问题

1. **问题描述**
   - **位置**:
   - **截图**:
   - **重现步骤**:
   - **严重程度**: (P0/P1/P2)

---

## 测试数据

### 测试的路径

| 输入路径 | 预期输出 | 实际输出 | 状态 |
|---------|---------|---------|------|
| `C:\Users\test` | `C:\Users\test` | | |
| `/home/user/repo` | `/home/user/repo` | | |

### 测试的浏览器

| 浏览器 | 版本 | 文件选择器 | 降级方案 | 状态 |
|-------|------|----------|---------|------|
| Chrome | | | | |
| Firefox | | | | |
| Safari | | | | |
| Edge | | | | |

---

## 建议

### 需要修复的问题

1.
2.

### 改进建议

1.
2.

---

## 附录

### 测试日志

```
[测试过程中的日志输出]
```

### 截图

- [仓库路径管理页面]
- [配置源管理页面]
- [首次运行向导页面]
- [错误消息示例]

---

**测试人员签字**: _______________
**测试日期**: _______________
```

---

## ✅ 验收标准

- [ ] 所有P0级别测试通过
- [ ] 所有P1级别测试通过
- [ ] P2级别测试至少80%通过
- [ ] 文件选择器在支持的浏览器中正常工作
- [ ] 降级方案在不支持的浏览器中正常工作
- [ ] 路径规范化在所有平台上正确
- [ ] 国际化功能正常
- [ ] 无阻塞性问题
- [ ] 发现的问题已记录

---

## 📞 后续支持

如发现以下问题，请记录并反馈：

1. **功能问题**
   - 文件选择器不工作
   - 路径未正确规范化
   - 降级方案失败

2. **兼容性问题**
   - 特定浏览器不兼容
   - 特定平台路径处理错误

3. **国际化问题**
   - 翻译缺失
   - 翻译不准确

4. **改进建议**
   - 用户体验改进
   - 功能增强建议

---

## 🚀 快速验证命令

```bash
# 1. 启动应用（Windows）
start-dev.bat

# 2. 检查文件选择器 Hook
cat frontend/src/hooks/useFilePicker.ts

# 3. 检查路径工具
cat frontend/src/lib/pathUtils.ts

# 4. 检查组件更新
git diff HEAD~1 frontend/src/pages/settings/data-management/RepoPathManagement.tsx
git diff HEAD~1 frontend/src/pages/settings/data-management/ConfigSourceManagement.tsx
git diff HEAD~1 frontend/src/pages/settings/FirstRunWizard.tsx

# 5. 检查翻译文件
ls frontend/src/i18n/locales/zh-Hans/filePicker.json
ls frontend/src/i18n/locales/en/filePicker.json
```

---

## 📊 实现总结

### 新增文件

| 文件 | 功能 | 行数 |
|------|------|------|
| `useFilePicker.ts` | 文件选择器 Hook | ~200 |
| `pathUtils.ts` | 路径工具类 | ~300 |
| `filePicker.json` | 中文翻译 | ~40 |
| `filePicker.json` | 英文翻译 | ~40 |

### 修改文件

| 文件 | 修改内容 |
|------|---------|
| `RepoPathManagement.tsx` | 使用 `useFilePicker` 和 `normalizePath` |
| `ConfigSourceManagement.tsx` | 使用 `useFilePicker` 和 `normalizePath` |
| `FirstRunWizard.tsx` | 使用 `useFilePicker` 和 `normalizePath` |
| `hooks/index.ts` | 导出 `useFilePicker` |
| `settings.json` | 添加翻译键 |

### 功能特性

- ✅ 多环境文件选择支持
- ✅ 自动降级方案
- ✅ 跨平台路径处理
- ✅ 路径规范化
- ✅ 路径验证
- ✅ 国际化支持
- ✅ 错误处理

---

**文档状态**: ✅ 完成
**测试状态**: ⏳ 待进行
**下一步**: 执行测试并记录结果
